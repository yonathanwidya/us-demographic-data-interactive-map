<!DOCTYPE html>
<html>
<head>
    <title>US Demographics</title>
    <meta charset="utf-8">
    <link href=bootstrap-3.1.1-dist/css/bootstrap.css rel=stylesheet media="screen">
</head>

<body>
<style>

#divHeader {
	background-color: gray;
	height: 39px;
}

.headerElement {
	display: inline-block;
}

#divDemographicText {
	margin-left: 10px;
}

#divOptionText {
	margin-left: 20px;
}

#divCorrelationButton {
	position:absolute;
    right:0;
    margin-right:10px;
    margin-top: 4px;
}

.headerTitle {
	color: white;
	font-family: serif;
}

.selectionBox {
	margin-top: 9px;
	margin-left: 5px;
}

#divSvg {
	margin-top: 2px;
	margin-left: 10px;
	display: inline-block;
}

#svgArea1 {
	float: left;
	border-right: 1px solid black;
}

#svgArea2 {
	overflow: hidden;
}

.axis path,
.axis line {
    fill: none;
    stroke: black;
}

.axis text {
    font: 10px sans-serif;
}

.counties {
  fill: none;
}

.states {
  fill: #ccc;
  stroke: black;/*#fff;*/
  stroke-linejoin: round;
}

.states:hover {
  fill: red;
}

.blue_q0-8 { fill:#f7fbff; stroke: black;}
.blue_q1-8 { fill:#deebf7; stroke: black;}
.blue_q2-8 { fill:#c6dbef; stroke: black;}
.blue_q3-8 { fill:#9ecae1; stroke: black;}
.blue_q4-8 { fill:#6baed6; stroke: black;}
.blue_q5-8 { fill:#4292c6; stroke: black;}
.blue_q6-8 { fill:#2171b5; stroke: black;}
.blue_q7-8 { fill:#084594; stroke: black;}

.red_q0-8 { fill:#fff5f0; stroke: black;}
.red_q1-8 { fill:#fee0d2; stroke: black;}
.red_q2-8 { fill:#fcbba1; stroke: black;}
.red_q3-8 { fill:#fc9272; stroke: black;}
.red_q4-8 { fill:#fb6a4a; stroke: black;}
.red_q5-8 { fill:#ef3b2c; stroke: black;}
.red_q6-8 { fill:#cb181d; stroke: black;}
.red_q7-8 { fill:#99000d; stroke: black;}

.green_q0-8 { fill:#f7fcf5; stroke: black;}
.green_q1-8 { fill:#e5f5e0; stroke: black;}
.green_q2-8 { fill:#c7e9c0; stroke: black;}
.green_q3-8 { fill:#a1d99b; stroke: black;}
.green_q4-8 { fill:#74c476; stroke: black;}
.green_q5-8 { fill:#41ab5d; stroke: black;}
.green_q6-8 { fill:#238b45; stroke: black;}
.green_q7-8 { fill:#005a32; stroke: black;}

.orange_q0-8 { fill:#fff5eb; stroke: black;}
.orange_q1-8 { fill:#fee6ce; stroke: black;}
.orange_q2-8 { fill:#fdd0a2; stroke: black;}
.orange_q3-8 { fill:#fdae6b; stroke: black;}
.orange_q4-8 { fill:#fd8d3c; stroke: black;}
.orange_q5-8 { fill:#f16913; stroke: black;}
.orange_q6-8 { fill:#d94801; stroke: black;}
.orange_q7-8 { fill:#8c2d04; stroke: black;}

</style>

<div id="divHeader">
	<div class="headerElement" id ="divDemographicText">
		<h4 class="headerTitle">Select Demographic Data:</h4>
	</div>
	<div class="headerElement">
		<select class="selectionBox" id="demographicSelectionBox" onchange="update()">
			<option value="populationDensity">Population Density</option>
			<option value="incomePerCapita">Income Per Capita </option>
			<option value="bachelor">Education (Bachelor Degree and above) </option>
			<option value="populationBelowPoverty">Population Below Poverty</option>
			<option value="unemployment">Unemployment Rate</option>
			<option value="election">2008 Presidential Election</option>
			<option value="foreignBorn">Foreign-Born Population</option>
		</select>
	</div>
	<div class="headerElement" id ="divOptionText">
		<h4 class="headerTitle">Select Option:</h4>
	</div>
	<div class="headerElement">
		<select class="selectionBox" id="optionSelectionBox" onchange="update()">
			<option value="perState">Display per State</option>
			<option value="perCounty">Display per County</option>
		</select>
	</div>
	<div class="headerElement" id="divCorrelationButton">
		<a href="Correlation.html">
		<img src="http://dabuttonfactory.com/button.png?t=Click+to+Check+Correlation&f=Komika-Bold&ts=14&tc=fff&tshs=1&tshc=000&hp=20&vp=8&c=5&bgt=gradient&bgc=3d85c6&ebgc=073763"/>
		</a>
	</div>
</div>
<div id="divSvg">
    <div id="svgArea1"></div>
    <div id="svgArea2"></div>
</div>

<script src=jquery-2.1.0/jquery-2.1.0.min.js></script>
<script src=bootstrap-3.1.1-dist/js/bootstrap.min.js></script>
<script src=D3/d3.min.js></script>
<script src=D3/queue.v1.min.js></script>
<script src=D3/topojson.v1.min.js></script>
<script src=accounting.min.js></script>

<script>
var screenWidth = screen.width;
var screenHeight = screen.height;
var svg_1_width = 960 / 1366 * screenWidth, svg_1_height = 610 / 768 * screenHeight;
var svg_2_width = 360 / 1366 * screenWidth, svg_2_height = 600 / 768 * screenHeight;

var svg1 = d3.select("#svgArea1")
			.append("svg")
			.attr("width", svg_1_width)
		    .attr("height", svg_1_height);

var svg2 = d3.select("#svgArea2")
			.append("svg")
			.attr("width", svg_2_width)
		    .attr("height", svg_2_height);


var previous_clickedState_code = "";
var current_clickedState_code = "";

var previous_clickedCounty_id = 0;
var current_clickedCounty_id = 0;


var populationDensity_by_countyId = d3.map();
var populationDensity_by_stateId = d3.map();

var incomePerCapita_by_countyId = d3.map();
var incomePerCapita_by_stateId = d3.map();

var bachelor_by_countyId = d3.map();
var bachelor_by_stateId = d3.map();

var populationBelowPoverty_by_countyId = d3.map();
var populationBelowPoverty_by_stateId = d3.map();

var unemploymentRate_by_countyId = d3.map();
var unemploymentRate_by_stateName = d3.map();

var party_by_countyId = d3.map();
var party_by_stateId = d3.map();

var election_by_countyId = d3.map();
var election_by_stateId = d3.map();

var foreignBorn_by_countyId = d3.map();
var foreignBorn_by_stateId = d3.map();

var quantize_populationDensity = d3.scale.quantize()
	.domain([0,600])
	.range(d3.range(8).map(function(i) { return "blue_q" + i + "-8"; }));

var quantize_incomePerCapita = d3.scale.quantize()
	.domain([0,40000])
	.range(d3.range(8).map(function(i) { return "green_q" + i + "-8"; }));

var quantize_bachelor = d3.scale.quantize()
	.domain([0,40])
	.range(d3.range(8).map(function(i) { return "orange_q" + i + "-8"; }));

var quantize_populationBelowPoverty = d3.scale.quantize()
	.domain([0,.4])
	.range(d3.range(8).map(function(i) { return "red_q" + i + "-8"; }));

var quantize_unemployment = d3.scale.quantize()
    .domain([0, .16])
    .range(d3.range(8).map(function(i) { return "blue_q" + i + "-8"; }));

var quantize_election_democratic = d3.scale.quantize()
    .domain([40, 80])
    .range(d3.range(8).map(function(i) { return "blue_q" + i + "-8"; }));

var quantize_election_republican = d3.scale.quantize()
    .domain([40, 80])
    .range(d3.range(8).map(function(i) { return "red_q" + i + "-8"; }));

var quantize_foreignBorn = d3.scale.quantize()
    .domain([0, 32])
    .range(d3.range(8).map(function(i) { return "orange_q" + i + "-8"; }));

var projection = d3.geo.albersUsa()
    .scale(1280 / 1366 * screenWidth)
    .translate([svg_1_width / 2, svg_1_height / 2]);

var path = d3.geo.path()
    .projection(projection);

var graph = svg1.append("g");


update();

function update()
{
	// Remove contents...
	d3.selectAll("path").remove();
	d3.selectAll(".legend").remove();
	d3.selectAll(".detailMap").remove();
  	d3.selectAll(".detailText").remove();
  	d3.selectAll(".line").remove();
  	d3.selectAll(".axis").remove();
  	d3.selectAll(".chart").remove();
  	previous_clickedState_code = "";
  	current_clickedState_code = "";

  	var demographicSelection = document.getElementById("demographicSelectionBox");
  	var dataFile = "";

  	if (demographicSelection.options[demographicSelection.selectedIndex].value == "populationDensity")
	{
		dataFile = "population-density-by-county.csv";
  	}
	else if (demographicSelection.options[demographicSelection.selectedIndex].value == "incomePerCapita")
	{
		dataFile = "income-per-capita.csv";
	}
	else if (demographicSelection.options[demographicSelection.selectedIndex].value == "bachelor")
	{
		dataFile = "bachelor.csv";
	}
	else if (demographicSelection.options[demographicSelection.selectedIndex].value == "populationBelowPoverty")
	{
		dataFile = "population-below-poverty.csv";
	}
	else if (demographicSelection.options[demographicSelection.selectedIndex].value == "unemployment")
	{
		dataFile = "unemployment.csv";
	}
	else if (demographicSelection.options[demographicSelection.selectedIndex].value == "election")
	{
		dataFile = "presidential-election.csv";
	}
	else if (demographicSelection.options[demographicSelection.selectedIndex].value == "foreignBorn")
	{
		dataFile = "foreign_born.csv";
	}

  	queue()
    	.defer(d3.json, "us-named.json")
    	.defer(d3.tsv, "us-county-names-with-state.tsv")
	    .defer(d3.csv, dataFile)
	    .await(ready);

   	function ready(error, topology, countyDetails, data)
	{ 
	  	var demographicSelection = document.getElementById("demographicSelectionBox");
	  	var optionSelection = document.getElementById("optionSelectionBox");

	  	var classQuantize = 0;
	  	var classQuantize2 = 0;
	  	var legendTitle = "";
	  	var legendTitle2 = "";
	  	var legendPrefixText = "";
	  	var legendSuffixText = "";
	  	var dimensionMultiplier = 1;

	  	if (demographicSelection.options[demographicSelection.selectedIndex].value == "populationDensity")
		{
			// Process Population Density data...
			data.forEach(function(d)
			{
				if (+d.id % 1000 == 0) 	populationDensity_by_stateId.set(+d.id / 1000, +d.pop_density);
			  	else 					populationDensity_by_countyId.set(+d.id, +d.pop_density);
			});

			// Draw choropleth...
			if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_populationDensity(populationDensity_by_stateId.get(d.id)); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_populationDensity(populationDensity_by_countyId.get(d.id)); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_populationDensity;
			legendTitle = "People / sq. mile";
	  	}
		else if (demographicSelection.options[demographicSelection.selectedIndex].value == "incomePerCapita")
		{
			// Process Income Per Capita Data
			data.forEach(function(d)
			{
				if (+d.id % 1000 == 0) 	incomePerCapita_by_stateId.set(+d.id / 1000, +d.income_per_capita);
			  	else 					incomePerCapita_by_countyId.set(+d.id, +d.income_per_capita);
			});

			if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
		  		graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_incomePerCapita(incomePerCapita_by_stateId.get(d.id)); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_incomePerCapita(incomePerCapita_by_countyId.get(d.id)); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_incomePerCapita;
			legendTitle = "Income per Capita";
			legendPrefixText = "$";
			legendSuffixText = "k";
			dimensionMultiplier = 1 / 1000;
		}
		else if (demographicSelection.options[demographicSelection.selectedIndex].value == "bachelor")
		{
			// Process Bachelor Degree Data
			data.forEach(function(d)
			{
				if (+d.id % 1000 == 0) 	bachelor_by_stateId.set(+d.id / 1000, +d.bachelor);
			  	else 					bachelor_by_countyId.set(+d.id, +d.bachelor);
			});

			if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
		  		graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_bachelor(bachelor_by_stateId.get(d.id)); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_bachelor(bachelor_by_countyId.get(d.id)); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_bachelor;
			legendTitle = "Bachelor Degree";
			legendSuffixText = " %";
		}
		else if (demographicSelection.options[demographicSelection.selectedIndex].value == "populationBelowPoverty")
		{
			// Process Population Below Poverty Data
			data.forEach(function(d)
			{
				if (+d.id % 1000 == 0) 	populationBelowPoverty_by_stateId.set(+d.id / 1000, +d.below_poverty / +d.total);
			  	else 					populationBelowPoverty_by_countyId.set(+d.id, +d.below_poverty / +d.total);
			});

			if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
		  		graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_populationBelowPoverty(populationBelowPoverty_by_stateId.get(d.id)); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_populationBelowPoverty(populationBelowPoverty_by_countyId.get(d.id)); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_populationBelowPoverty;
			legendTitle = "Poverty";
			legendSuffixText = " %";
			dimensionMultiplier = 100;
		}
		else if (demographicSelection.options[demographicSelection.selectedIndex].value == "unemployment")
		{
			// Process Unemployment Data
		  	data.forEach(function(d) { unemploymentRate_by_countyId.set(d.id, +d.rate); });
		  	getUnemploymentRateByState(countyDetails);

		  	if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_unemployment(unemploymentRate_by_stateName.get(d.properties.name)); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_unemployment(unemploymentRate_by_countyId.get(d.id)); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_unemployment;
			legendTitle = "Unemployment";
			legendSuffixText = " %";
			dimensionMultiplier = 100;
		}
		else if (demographicSelection.options[demographicSelection.selectedIndex].value == "election")
		{
			// Process Election Data
			data.forEach(function(d)
			{
				var winningPartyPercentage = 0;

				party_by_stateId.set(+d.id / 1000, d.party);
			  	party_by_countyId.set(+d.id, d.party);

				if (+d.party == 1)	winningPartyPercentage = +d.democratic;
				else 				winningPartyPercentage = +d.republican;

			  	if (+d.id % 1000 == 0) 	election_by_stateId.set(+d.id / 1000, winningPartyPercentage);
			  	else 					election_by_countyId.set(+d.id, winningPartyPercentage);
			});

			if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return getElectionClassByState(d); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.filter(function(d) { return d.properties.state != "Alaska" }) 
					.attr("class", function(d) { return getElectionClassByCounty(d); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_election_democratic;
			classQuantize2 = quantize_election_republican;
			legendTitle = "Democratic";
			legendTitle2 = "Republican";
			legendSuffixText = " %";
		}
		else if (demographicSelection.options[demographicSelection.selectedIndex].value == "foreignBorn")
		{
			// Process Population Below Poverty Data
			data.forEach(function(d)
			{
				if (+d.id % 1000 == 0) 	foreignBorn_by_stateId.set(+d.id / 1000, +d.foreign_born);
			  	else 					foreignBorn_by_countyId.set(+d.id, +d.foreign_born);
			});
			
			if (optionSelection.options[optionSelection.selectedIndex].value == "perState")
			{
		  		graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.states).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_foreignBorn(foreignBorn_by_stateId.get(d.id)); })
					.attr("id", function(d) { return d.properties.code; })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverState(this, d, topology); })
					.on("mouseout", function(d) { mouseOutState(this, d, topology); })
					.on("click", function(d) { clickState(this, d, topology); });
			}
			else if (optionSelection.options[optionSelection.selectedIndex].value == "perCounty")
			{
				graph.selectAll("path")
					.data(topojson.feature(topology, topology.objects.counties).features)
					.enter().append("path")
					.attr("class", function(d) { return quantize_foreignBorn(foreignBorn_by_countyId.get(d.id)); })
					.attr("d", path)
					.on("mouseover", function(d) { mouseOverCounty(this, d, topology); })
					.on("mouseout", function(d) { mouseOutCounty(this); })
			}

			classQuantize = quantize_foreignBorn;
			legendTitle = "Foreign-Born";
			legendSuffixText = " %";
		}


		//
		// Draw legend...
		//
		
		var length = classQuantize.range().length;
		var domainRange = classQuantize.domain()[1] - classQuantize.domain()[0];
		var rangeStep = domainRange / length;
		var domainBase = classQuantize.domain()[0];
		var legendText = "";

		// Draw legend box...
		if (classQuantize2 != 0)
		{
			graph.append("g")
				.attr("class", "legend")
				.append("rect")
				.attr("x", 840 / 960 * svg_1_width)
			 	.attr("y", 435 / 610 * svg_1_height)
				.attr("width", 110 / 960 * svg_1_width)
				.attr("height", 140 / 610 * svg_1_height)
				.style("stroke", "black")
				.style("fill", "none");

			graph.append("g")
				.attr("class", "legend")
				.append("rect")
				.attr("x", 840 / 960 * svg_1_width)
			 	.attr("y", 380 / 610 * svg_1_height)
				.attr("width", 110 / 960 * svg_1_width)
				.attr("height", 55 / 610 * svg_1_height)
				.style("stroke", "black")
				.style("fill", "none");
		}
		else
		{
			graph.append("g")
				.attr("class", "legend")
				.append("rect")
				.attr("x", 840 / 960 * svg_1_width)
			 	.attr("y", 410 / 610 * svg_1_height)
				.attr("width", 110 / 960 * svg_1_width)
				.attr("height", 165 / 610 * svg_1_height)
				.style("stroke", "black")
				.style("fill", "none");
		}

		// Draw legend title text...
		if (classQuantize2 != 0)
		{
			graph.append("g")
				.attr("class", "legend")
				.append("rect")
				.attr("class", classQuantize.range()[length - 1])
				.attr("x", 850 / 960 * svg_1_width)
			 	.attr("y", (390 / 610 * svg_1_height))
				.attr("width", 15 / 610 * svg_1_height)
				.attr("height", 15 / 610 * svg_1_height);

			graph.append("g")
				.attr("class", "legend")
				.append("rect")
				.attr("class", classQuantize2.range()[length - 1])
				.attr("x", 850 / 960 * svg_1_width)
			 	.attr("y", (410 / 610 * svg_1_height))
				.attr("width", 15 / 610 * svg_1_height)
				.attr("height", 15 / 610 * svg_1_height);

			graph.append("g")
				.attr("class", "legend")
				.append("text")
				.attr("x", 875 / 960 * svg_1_width)
			 	.attr("y", (402 / 610 * svg_1_height))
			 	.attr("text-anchor", "start")
				.attr("font-family", "serif")
				.attr("font-size", "12px")
				.text(legendTitle);

			graph.append("g")
				.attr("class", "legend")
				.append("text")
				.attr("x", 875 / 960 * svg_1_width)
			 	.attr("y", (422 / 610 * svg_1_height))
			 	.attr("text-anchor", "start")
				.attr("font-family", "serif")
				.attr("font-size", "12px")
				.text(legendTitle2);
		}
		else
		{
			graph.append("g")
				.attr("class", "legend")
				.append("text")
				.attr("x", 850 / 960 * svg_1_width)
			 	.attr("y", (430 / 610 * svg_1_height))
			 	.attr("text-anchor", "start")
				.attr("font-family", "serif")
				.attr("font-size", "12px")
				.text(legendTitle);
		}

		for (var i = 0; i < length; i++)
		{
			// Draw color legend...
			graph.append("g")
				.attr("class", "legend")
				.append("rect")
				.attr("class", classQuantize.range()[i])
				.attr("x", 850 / 960 * svg_1_width)
			 	.attr("y", (550 / 610 * svg_1_height) - (i * (15 / 610 * svg_1_height)))
				.attr("width", 15 / 610 * svg_1_height)
				.attr("height", 15 / 610 * svg_1_height);

			if (classQuantize2 != 0)
			{
				// Draw color legend...
				graph.append("g")
					.attr("class", "legend")
					.append("rect")
					.attr("class", classQuantize2.range()[i])
					.attr("x", 925 / 960 * svg_1_width)
				 	.attr("y", (550 / 610 * svg_1_height) - (i * (15 / 610 * svg_1_height)))
					.attr("width", 15 / 610 * svg_1_height)
					.attr("height", 15 / 610 * svg_1_height);
			};
			
			// Determine legend text...
			if (i == (length - 1))	legendText = "> " + legendPrefixText + Math.round(((rangeStep * i) + domainBase) * dimensionMultiplier) + legendSuffixText;
			else 					legendText = legendPrefixText + Math.round(((rangeStep * i) + domainBase) * dimensionMultiplier) + " - " + legendPrefixText + Math.round(((rangeStep * (i + 1)  + domainBase))  * dimensionMultiplier) + legendSuffixText;

			// Draw legend text...
			if (classQuantize2 != 0)
			{
				graph.append("g")
					.attr("class", "legend")
					.append("text")
					.attr("x", 895 / 960 * svg_1_width)
				 	.attr("y", (562 / 610 * svg_1_height) - (i * 15))
				 	.attr("text-anchor", "middle")
	    			.attr("font-family", "serif")
					.attr("font-size", "10px")
					.text(legendText);
			}
			else
			{
				graph.append("g")
					.attr("class", "legend")
					.append("text")
					.attr("x", 875 / 960 * svg_1_width)
				 	.attr("y", (562 / 610 * svg_1_height) - (i * 15))
				 	.attr("text-anchor", "start")
	    			.attr("font-family", "serif")
					.attr("font-size", "10px")
					.text(legendText);
			}
		}
	}
}

function getUnemploymentRateByState(countyDetails)
{
  	var currentStateName = '';
 	var totalCounty = 0;
  	var totalRate = 0;

  	countyDetails.forEach(function(d)
  	{
    	if (currentStateName != d.state)
    	{
      		if (currentStateName != '' && totalCounty != 0)
      		{
        		var rate = totalRate / totalCounty;
        		unemploymentRate_by_stateName.set(currentStateName, rate);
      		}

      		currentStateName = d.state;
      		totalCounty = 0;
      		totalRate = 0;
    	}

    	if (unemploymentRate_by_countyId.get(d.id))
    	{
      		totalRate += unemploymentRate_by_countyId.get(d.id);
      		totalCounty += 1;
    	};
  	});
}

function getElectionClassByState(d)
{
	if (party_by_stateId.get(d.id) == "1")	return quantize_election_democratic(election_by_stateId.get(d.id));
	else 									return quantize_election_republican(election_by_stateId.get(d.id));
}

function getElectionClassByCounty(d)
{
	if (party_by_countyId.get(d.id) == "1")	return quantize_election_democratic(election_by_countyId.get(d.id));
	else 									return quantize_election_republican(election_by_countyId.get(d.id));
}

function getElectionClassByCountyId(i)
{
	if (party_by_countyId.get(i) == "1")	return quantize_election_democratic(election_by_countyId.get(i));
	else 									return quantize_election_republican(election_by_countyId.get(i));
}

function mouseOverState(object, state, topology)
{
	var selection = document.getElementById("demographicSelectionBox");

	if (selection.options[selection.selectedIndex].value == "election" ||
		selection.options[selection.selectedIndex].value == "populationBelowPoverty")
	{
		d3.select(object).style("fill", "yellow");
	}
	else if (selection.options[selection.selectedIndex].value == "bachelor" ||
		selection.options[selection.selectedIndex].value == "foreignBorn")
	{
		d3.select(object).style("fill", "skyblue");
	}
	else
	{
		d3.select(object).style("fill", "red");
	}

	showSideBarState(object, state, topology);
}

function mouseOutState(object, state, topology)
{
  	var selection = document.getElementById("demographicSelectionBox");

  	if (state.properties.code == current_clickedState_code)
  	{
  		if (selection.options[selection.selectedIndex].value == "incomePerCapita")
		{
			d3.select(object).style("fill", "orange");
		}
		else
		{
  			d3.select(object).style("fill", "green");
  		}
  	}
  	else
  	{
		revertColor(object);
	}

  	if (current_clickedState_code == "")
	{
		// Remove previous county details map & chart...
	  	d3.selectAll(".detailMap").remove();
	  	d3.selectAll(".detailText").remove();
	  	d3.selectAll(".line").remove();
	  	d3.selectAll(".axis").remove();
	  	d3.selectAll(".chart").remove();
	}
	else
	{
		topojson.feature(topology, topology.objects.states).features.forEach(function(d)
  		{
  			if (d.properties.code == current_clickedState_code)
  			{
  				showSideBarState(d3.select("#" + d.properties.code)[0][0], d, topology);
  			};
  		});
	}
}

function clickState(object, state, topology)
{
	// Update which state is clicked now...
	previous_clickedState_code = current_clickedState_code;
  	current_clickedState_code = state.properties.code;

  	// Change color of the clicked state...
  	var selection = document.getElementById("demographicSelectionBox");
  	if (selection.options[selection.selectedIndex].value == "incomePerCapita")
	{
		d3.select(object).style("fill", "orange");
	}
	else
	{
		d3.select(object).style("fill", "green");
	}

  	if (previous_clickedState_code != "")
  	{
  		topojson.feature(topology, topology.objects.states).features.forEach(function(d)
  		{
  			if (d.properties.code == previous_clickedState_code)
  			{
  				mouseOutState(d3.select("#" + d.properties.code)[0][0], d, topology);
  			};
  		});
  	}
  	else
  	{
  		showSideBarState(object, state, topology);
  	}
}

function mouseOverCounty(object, county, topology)
{
	var selection = document.getElementById("demographicSelectionBox");

	if (selection.options[selection.selectedIndex].value == "election" ||
		selection.options[selection.selectedIndex].value == "populationBelowPoverty")
	{
		d3.select(object).style("fill", "yellow");
	}
	else if (selection.options[selection.selectedIndex].value == "bachelor" ||
		selection.options[selection.selectedIndex].value == "foreignBorn")
	{
		d3.select(object).style("fill", "skyblue");
	}
	else
	{
		d3.select(object).style("fill", "red");
	}

	showSideBarCounty(object, county, topology);
}

function mouseOutCounty(object)
{
  	d3.selectAll(".detailText").remove();
  	d3.selectAll(".chart").remove();

	revertColor(object);
}

function mouseOverChart(object, countyId, topology)
{
	var selection = document.getElementById("demographicSelectionBox");
	var countyPath = d3.select("#id" + countyId)[0][0];

	if (selection.options[selection.selectedIndex].value == "election" ||
		selection.options[selection.selectedIndex].value == "populationBelowPoverty")
	{
		d3.select(object).style("fill", "yellow");
		d3.select(countyPath).style("fill", "yellow");
	}
	else if (selection.options[selection.selectedIndex].value == "bachelor" ||
		selection.options[selection.selectedIndex].value == "foreignBorn")
	{
		d3.select(object).style("fill", "skyblue");
		d3.select(countyPath).style("fill", "skyblue");
	}
	else
	{
		d3.select(object).style("fill", "red");
		d3.select(countyPath).style("fill", "red");
	}

	topojson.feature(topology, topology.objects.counties).features.forEach(function(d)
	{
		if (d.id == countyId)
		{
			d3.select("#stateNameText").text(d.properties.name + ", " + d.properties.state);

			var text = getFigureTextByCounty(d.id);
			d3.select("#figureText").text(text);
		};
	});
}

function mouseOutChart(object, countyId, topology)
{
	var countyPath = d3.select("#id" + countyId)[0][0];

	revertColor(object);
	revertColor(countyPath);

	topojson.feature(topology, topology.objects.counties).features.forEach(function(d)
	{
		if (d.id == countyId)
		{
			d3.select("#stateNameText").text(d.properties.state);

			var text = getFigureTextByState(Math.round(+d.id / 1000), d.properties.state);
			d3.select("#figureText").text(text);
		};
	});
}

function revertColor(object)
{
	if      (d3.select(object).attr("class") == "blue_q0-8")  d3.select(object).style("fill", "#f7fbff")
	else if (d3.select(object).attr("class") == "blue_q1-8")  d3.select(object).style("fill", "#deebf7")
	else if (d3.select(object).attr("class") == "blue_q2-8")  d3.select(object).style("fill", "#c6dbef")
	else if (d3.select(object).attr("class") == "blue_q3-8")  d3.select(object).style("fill", "#9ecae1")
	else if (d3.select(object).attr("class") == "blue_q4-8")  d3.select(object).style("fill", "#6baed6")
	else if (d3.select(object).attr("class") == "blue_q5-8")  d3.select(object).style("fill", "#4292c6")
	else if (d3.select(object).attr("class") == "blue_q6-8")  d3.select(object).style("fill", "#2171b5")
	else if (d3.select(object).attr("class") == "blue_q7-8")  d3.select(object).style("fill", "#084594")

	else if (d3.select(object).attr("class") == "red_q0-8")  d3.select(object).style("fill", "#fff5f0")
	else if (d3.select(object).attr("class") == "red_q1-8")  d3.select(object).style("fill", "#fee0d2")
	else if (d3.select(object).attr("class") == "red_q2-8")  d3.select(object).style("fill", "#fcbba1")
	else if (d3.select(object).attr("class") == "red_q3-8")  d3.select(object).style("fill", "#fc9272")
	else if (d3.select(object).attr("class") == "red_q4-8")  d3.select(object).style("fill", "#fb6a4a")
	else if (d3.select(object).attr("class") == "red_q5-8")  d3.select(object).style("fill", "#ef3b2c")
	else if (d3.select(object).attr("class") == "red_q6-8")  d3.select(object).style("fill", "#cb181d")
	else if (d3.select(object).attr("class") == "red_q7-8")  d3.select(object).style("fill", "#99000d")

	else if (d3.select(object).attr("class") == "green_q0-8")  d3.select(object).style("fill", "#f7fcf5")
	else if (d3.select(object).attr("class") == "green_q1-8")  d3.select(object).style("fill", "#e5f5e0")
	else if (d3.select(object).attr("class") == "green_q2-8")  d3.select(object).style("fill", "#c7e9c0")
	else if (d3.select(object).attr("class") == "green_q3-8")  d3.select(object).style("fill", "#a1d99b")
	else if (d3.select(object).attr("class") == "green_q4-8")  d3.select(object).style("fill", "#74c476")
	else if (d3.select(object).attr("class") == "green_q5-8")  d3.select(object).style("fill", "#41ab5d")
	else if (d3.select(object).attr("class") == "green_q6-8")  d3.select(object).style("fill", "#238b45")
	else if (d3.select(object).attr("class") == "green_q7-8")  d3.select(object).style("fill", "#005a32")

	else if (d3.select(object).attr("class") == "orange_q0-8")  d3.select(object).style("fill", "#fff5eb")
	else if (d3.select(object).attr("class") == "orange_q1-8")  d3.select(object).style("fill", "#fee6ce")
	else if (d3.select(object).attr("class") == "orange_q2-8")  d3.select(object).style("fill", "#fdd0a2")
	else if (d3.select(object).attr("class") == "orange_q3-8")  d3.select(object).style("fill", "#fdae6b")
	else if (d3.select(object).attr("class") == "orange_q4-8")  d3.select(object).style("fill", "#fd8d3c")
	else if (d3.select(object).attr("class") == "orange_q5-8")  d3.select(object).style("fill", "#f16913")
	else if (d3.select(object).attr("class") == "orange_q6-8")  d3.select(object).style("fill", "#d94801")
	else if (d3.select(object).attr("class") == "orange_q7-8")  d3.select(object).style("fill", "#8c2d04")
}

function showSideBarState(object, state, topology)
{
  	// First of all, remove previous county details map & chart...
  	d3.selectAll(".detailMap").remove();
  	d3.selectAll(".detailText").remove();
  	d3.selectAll(".line").remove();
  	d3.selectAll(".axis").remove();
  	d3.selectAll(".chart").remove();

  	var selection = document.getElementById("demographicSelectionBox");

	var topFiveId = [0, 0, 0, 0, 0];
	var topFiveName = [0, 0, 0, 0, 0];
	var topFiveValue = [0, 0, 0, 0, 0];


  	//
  	// The below code is to scale the selected state to draw the county details map...
  	//

  	var rect = object.getBoundingClientRect();

  	var scale = 1;
  	if (rect.width > rect.height)	scale = (200 / 600 * svg_2_height) / rect.width;
  	else							scale = (200 / 600 * svg_2_height) / rect.height;

  	var offsetX = ((0 - rect.left + (10 / 360 * svg_2_width)) * scale);
  	var offsetY = ((0 - rect.top + (42 / 600 * svg_2_height)) * scale);

  	var scrollTop = $(window).scrollTop();

  	var detailProjection = d3.geo.albersUsa()
    							.translate([(svg_1_width * scale / 2) + offsetX, ((svg_1_height - (2 * scrollTop)) * scale / 2) + offsetY])
    							.scale((1280 / 1366 * screenWidth) * scale);

	var detailPath = d3.geo.path().projection(detailProjection);


	//
	// Draw the county details map...
	//

	var transformX = ((410 / 360 * svg_2_width) - (rect.width * scale)) / 2;
	var transformY = ((310 / 600 * svg_2_height) - (rect.height * scale)) / 2;

	// Special treatment for election result in Alaska...
	// The election in Alaska is not divided per county...
	if (selection.options[selection.selectedIndex].value == "election" &&
		state.properties.name == "Alaska")
	{
		topojson.feature(topology, topology.objects.states).features.forEach(function(d)
	  	{
	    	if (d.properties.name == state.properties.name)
	    	{
	    		svg2.append("g")
		          		.attr("class", "detailMap")
		          		.attr("transform", "translate(" + transformX + "," + transformY + ")")
		          		.datum(d)
		          		.append("path")
		          		.attr("class", function(d) { return getElectionClassByState(d); })
		          		.attr("d", detailPath);
	    	}
	    });
	}
	else
	{
		topojson.feature(topology, topology.objects.counties).features.forEach(function(d)
	  	{
	    	if (d.properties.state == state.properties.name)
	    	{
	      		var className = "";

	      		if (selection.options[selection.selectedIndex].value == "populationDensity")
				{
		      		className = quantize_populationDensity(populationDensity_by_countyId.get(d.id));
		        }
		        else if (selection.options[selection.selectedIndex].value == "bachelor")
				{
		      		className = quantize_bachelor(bachelor_by_countyId.get(d.id));
		        }
		        else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
				{
		      		className = quantize_incomePerCapita(incomePerCapita_by_countyId.get(d.id));
		        }
		        else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
				{
		      		className = quantize_populationBelowPoverty(populationBelowPoverty_by_countyId.get(d.id));
		        }
	      		else if (selection.options[selection.selectedIndex].value == "unemployment")
				{
		      		className = quantize_unemployment(unemploymentRate_by_countyId.get(d.id));
		        }
		        else if (selection.options[selection.selectedIndex].value == "election")
				{
		      		className = getElectionClassByCounty(d);
		        }
		        else if (selection.options[selection.selectedIndex].value == "foreignBorn")
				{
		      		className = quantize_foreignBorn(foreignBorn_by_countyId.get(d.id));
		        };

		        svg2.append("g")
		          		.attr("class", "detailMap")
		          		.attr("transform", "translate(" + transformX + "," + transformY + ")")
		          		.datum(d)
		          		.append("path")
		          		.attr("class", className)
		          		.attr("id", function(d) { return "id" + +d.id })
		          		.attr("d", detailPath);

		        // Find top five id, name and values...
	          	updateOrderDescending(d.id, d.properties.name, topFiveId, topFiveName, topFiveValue, 0);
	    	};
	  	});
	}
	
	// Draw the state name...
  	svg2.append("text")
  		.attr("class", "detailText")
  		.attr("id", "stateNameText")
        .attr("text-anchor", "middle")
        .attr("x", 200 / 360 * svg_2_width)
        .attr("y", 35 / 600 * svg_2_height)
        .attr("font-family", "serif")
		.attr("font-size", "30px")
        .text(state.properties.name);

    // Draw the figure text...
    var text = getFigureTextByState(state.id, state.properties.name);
    
    svg2.append("text")
     	.attr("class", "detailText")
     	.attr("id", "figureText")
     	.attr("text-anchor", "middle")
      	.attr("x", 200 / 360 * svg_2_width)
      	.attr("y", 295 / 600 * svg_2_height)
      	.attr("font-family", "serif")
     	.attr("font-size", "20px")
     	.text(text);


    //
    // Draw chart...
    //

    if (selection.options[selection.selectedIndex].value == "election" &&
		state.properties.name == "Alaska")
	{
		// Do not draw chart for Election result in Alaska...
	}
	else
	{
		trimTopFive(topFiveId, topFiveName, topFiveValue);

	    var domain = [0, 0];

	    if 		(selection.options[selection.selectedIndex].value == "populationDensity")		domain = [0, topFiveValue[0]];
	    else if (selection.options[selection.selectedIndex].value == "incomePerCapita")			domain = [0, 60000];
	    else if (selection.options[selection.selectedIndex].value == "bachelor")				domain = [0, 100];
	    else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")	domain = [0, 100];
	    else if (selection.options[selection.selectedIndex].value == "unemployment")			domain = [0, 25];
	    else if (selection.options[selection.selectedIndex].value == "election")				domain = [40, 100];
	    else if (selection.options[selection.selectedIndex].value == "foreignBorn")				domain = [0, 50];

	    var xScale = d3.scale.linear()
	    				.range([0, (svg_2_width - (110 / 360 * svg_2_width))])
	    				.domain(domain);
	    var yScale = d3.scale.ordinal()
	    				.rangeRoundBands([(375 / 600 * svg_2_height), (580 / 600 * svg_2_height)], .2)
	    				.domain(topFiveName);

	    var xAxis = d3.svg.axis()
	                .scale(xScale)
	                .orient("bottom")
	                .ticks(5);
	    var yAxis = d3.svg.axis()
	                .scale(yScale)
	                .orient("left");

	    svg2.append("g")
	        .attr("class", "axis")
	        .attr("transform", "translate(" + 80 / 360 * svg_2_width + "," + 580 / 600 * svg_2_height + ")")
	        .call(xAxis);
	    svg2.append("g")
	        .attr("class", "axis")
	        .attr("transform", "translate(" + 80 / 360 * svg_2_width + "," + 0 + ")")
	        .call(yAxis);


	    // Draw the chart values...
	    var classQuantize = "";
	    var dataByCounty = "";
	    var scalingFactor = 1;
	    var axisText = "";

	    if (selection.options[selection.selectedIndex].value == "populationDensity")
		{
	      	classQuantize = quantize_populationDensity;
	      	dataByCounty = populationDensity_by_countyId;
	      	axisText = "(ppl / sq. mi)";
	    }
	    else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
		{
	      	classQuantize = quantize_incomePerCapita;
	      	dataByCounty = incomePerCapita_by_countyId;
	      	axisText = "(in US$)";
	    }
	    else if (selection.options[selection.selectedIndex].value == "bachelor")
		{
	      	classQuantize = quantize_bachelor;
	      	dataByCounty = bachelor_by_countyId;
	      	axisText = "(in %)";
	    }
	    else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
		{
	      	classQuantize = quantize_populationBelowPoverty;
	      	dataByCounty = populationBelowPoverty_by_countyId;
	      	scalingFactor = 100;
	      	axisText = "(in %)";
	    }
	    else if (selection.options[selection.selectedIndex].value == "unemployment")
		{
	      	classQuantize = quantize_unemployment;
	      	dataByCounty = unemploymentRate_by_countyId;
	      	scalingFactor = 100;
	      	axisText = "(in %)";
	    }
	    else if (selection.options[selection.selectedIndex].value == "election")
		{
	      	axisText = "(in %)";
	    }
	    else if (selection.options[selection.selectedIndex].value == "foreignBorn")
		{
	      	classQuantize = quantize_foreignBorn;
	      	dataByCounty = foreignBorn_by_countyId;
	      	axisText = "(in %)";
	    };

	    for (var i = 0; i < topFiveName.length; i++)
	    {
	    	if (selection.options[selection.selectedIndex].value == "election")	className = getElectionClassByCountyId(topFiveId[i]);
	    	else 																className = classQuantize(dataByCounty.get(topFiveId[i]));

	    	svg2.append("g")
		    	.attr("class", "chart")
		    	.datum(i)
		        .append("rect")
		        .attr("class", className)
		        .attr("x", 80 / 360 * svg_2_width)
		        .attr("y", function(d) { return yScale(topFiveName[d]); })
		        .attr("width", function(d) { return xScale(topFiveValue[d]) * scalingFactor; })
		        .attr("height", yScale.rangeBand())
		        .on("mouseover", function(d) { mouseOverChart(this, topFiveId[d], topology); })
		        .on("mouseout", function(d) { mouseOutChart(this, topFiveId[d], topology); });
	    }

	    // Draw the chart text...
	    svg2.append("text")
	     	.attr("class", "detailText")
	     	.attr("text-anchor", "middle")
	      	.attr("x", 200 / 360 * svg_2_width)
	      	.attr("y", 350 / 600 * svg_2_height)
	      	.attr("font-family", "serif")
	     	.attr("font-size", "20px")
	     	.text("Top counties in " + state.properties.name);

	    svg2.append("text")
	     	.attr("class", "detailText")
	     	.attr("text-anchor", "end")
	      	.attr("x", 360 / 360 * svg_2_width)
	      	.attr("y", 570 / 600 * svg_2_height)
	      	.attr("font-family", "serif")
	     	.attr("font-size", "12px")
	     	.text(axisText);

	    // Draw Horizontal Line...
	    svg2.append("line")
	    	.attr("class", "line")
			.attr("x1", 20 / 360 * svg_2_width)
			.attr("y1", 315 / 600 * svg_2_height)
			.attr("x2", svg_2_width)
			.attr("y2", 315 / 600 * svg_2_height)
			.attr("stroke-width", 1)
			.attr("stroke", "black");
	}
}

function showSideBarCounty(object, county, topology)
{
	d3.selectAll(".chart").remove();
	d3.selectAll(".detailText").remove();

	// Draw the county name...
  	svg2.append("text")
  		.attr("class", "detailText")
        .attr("text-anchor", "middle")
        .attr("x", 200 / 360 * svg_2_width)
        .attr("y", 65 / 600 * svg_2_height)
        .attr("font-family", "serif")
		.attr("font-size", "30px")
        .text(county.properties.name + ", " + county.properties.state);

    // Draw the figure text...
    var text = getFigureTextByCounty(county.id);

    svg2.append("text")
	     	.attr("class", "detailText")
	     	.attr("text-anchor", "middle")
	      	.attr("x", 200 / 360 * svg_2_width)
	      	.attr("y", 95 / 600 * svg_2_height)
	      	.attr("font-family", "serif")
	     	.attr("font-size", "20px")
	     	.text(text);


	//
	// Draw chart...
	//

	var selection = document.getElementById("demographicSelectionBox");
	var domain = [0, 0];
	var className = "";

	var value = getFigureByCounty(county.id);
	var textValue = value;

	if (selection.options[selection.selectedIndex].value == "populationDensity")
	{
		domain = [0, 600];
		className = quantize_populationDensity(populationDensity_by_countyId.get(county.id));
		textValue = accounting.formatMoney(value, "", 1) + " ppl / sq. mi"
    }
    else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
    {
    	domain = [0, 40000];
    	className = quantize_incomePerCapita(incomePerCapita_by_countyId.get(county.id));
    	textValue = accounting.formatMoney(value, "$", 0);
    }
    else if (selection.options[selection.selectedIndex].value == "bachelor")
    {
    	domain = [0, 40];
    	className = quantize_bachelor(bachelor_by_countyId.get(county.id));
    	textValue = value + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
    {
    	domain = [0, .4];
    	className = quantize_populationBelowPoverty(populationBelowPoverty_by_countyId.get(county.id));
    	textValue = Math.round(value * 1000) / 10 + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "unemployment")
    {
    	domain = [0, .16];
    	className = quantize_unemployment(unemploymentRate_by_countyId.get(county.id));
    	textValue = Math.round(value * 1000) / 10 + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "election")
    {
    	domain = [40, 80];
    	className = getElectionClassByCountyId(county.id);
    	textValue = value + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "foreignBorn")
    {
    	domain = [0, 32];
    	className = quantize_foreignBorn(foreignBorn_by_countyId.get(county.id));
    	textValue = value + " %";
    };

    var yScale = d3.scale.linear()
    				.range([450 / 600 * svg_2_height, 150 / 600 * svg_2_height])
    				.domain(domain);

    var yPos = yScale(value);

    if (yPos < 150 / 600 * svg_2_height) yPos = 150 / 600 * svg_2_height;
    var height = (450 / 600 * svg_2_height) - yPos;		

    // Draw Chart
	svg2.append("g")
    	.attr("class", "chart")
        .append("rect")
        .attr("class", className)
        .attr("x", 150 / 360 * svg_2_width)
        .attr("y", yPos)
        .attr("width", 100 / 360 * svg_2_width)
        .attr("height", height);

    // Draw Line...
    svg2.append("line")
    	.attr("class", "chart")
		.attr("x1", 100 / 360 * svg_2_width)
		.attr("y1", 450 / 600 * svg_2_height)
		.attr("x2", 300 / 360 * svg_2_width)
		.attr("y2", 450 / 600 * svg_2_height)
		.attr("stroke-width", 1)
		.attr("stroke", "black");

    // Draw Text...
    svg2.append("g")
    	.attr("class", "chart")
        .append("text")
        .attr("class", "detailText")
        .attr("text-anchor", "middle")
        .attr("x", 200 / 360 * svg_2_width)
        .attr("y", 475 / 600 * svg_2_height)
        .text(textValue);
}

function getFigureTextByState(stateId, stateName)
{
	var selection = document.getElementById("demographicSelectionBox");
	var text = "";

	if (selection.options[selection.selectedIndex].value == "populationDensity")
	{
      	text = "Density: " + accounting.formatMoney(populationDensity_by_stateId.get(stateId), "", 1) + " people / sq. mile";
    }
    else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
	{
      	text = "Income Per Capita: " + accounting.formatMoney(incomePerCapita_by_stateId.get(stateId), "$", 0);
    }
    else if (selection.options[selection.selectedIndex].value == "bachelor")
	{
      	text = "Bachelor Degree and above: " + bachelor_by_stateId.get(stateId) + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
	{
      	text = "Population Below Poverty: " + Math.round(populationBelowPoverty_by_stateId.get(stateId) * 1000) / 10 + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "unemployment")
	{
      	text = "Unemployment Rate: " + Math.round(unemploymentRate_by_stateName.get(stateName) * 1000) / 10 + "%";
    }
    else if (selection.options[selection.selectedIndex].value == "election")
	{
      	var party = "";
      	if (party_by_stateId.get(stateId) == "1") 	party = "Democratic: ";
      	else 										party = "Republican: ";

      	text = party + election_by_stateId.get(stateId) + "%";
    }
    else if (selection.options[selection.selectedIndex].value == "foreignBorn")
	{
      	text = "Foreign-Born Population : " + foreignBorn_by_stateId.get(stateId) + " %";
    };

    return text;
}

function getFigureTextByCounty(countyId)
{
	var selection = document.getElementById("demographicSelectionBox");
	var text = "";

    if (selection.options[selection.selectedIndex].value == "populationDensity")
	{
      	text = "Density: " + accounting.formatMoney(populationDensity_by_countyId.get(countyId), "", 1) + " people / sq. mile";
    }
    else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
	{
      	text = "Income Per Capita: " + accounting.formatMoney(incomePerCapita_by_countyId.get(countyId), "$", 0);
    }
    else if (selection.options[selection.selectedIndex].value == "bachelor")
	{
      	text = "Bachelor Degree and above: " + bachelor_by_countyId.get(countyId) + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
	{
      	text = "Population Below Poverty: " + Math.round(populationBelowPoverty_by_countyId.get(countyId) * 1000) / 10 + " %";
    }
    else if (selection.options[selection.selectedIndex].value == "unemployment")
	{
      	text = "Unemployment Rate: " + Math.round(unemploymentRate_by_countyId.get(countyId) * 1000) / 10 + "%";
    }
    else if (selection.options[selection.selectedIndex].value == "election")
	{
      	var party = "";
      	if (party_by_countyId.get(countyId) == "1") 	party = "Democratic: ";
      	else 											party = "Republican: ";

      	text = party + election_by_countyId.get(countyId) + "%";
    }
    else if (selection.options[selection.selectedIndex].value == "foreignBorn")
	{
      	text = "Foreign-Born Population : " + foreignBorn_by_countyId.get(countyId) + " %";
    };

    return text;
}

function getFigureByCounty(countyId)
{
	var selection = document.getElementById("demographicSelectionBox");
	var value = 0;

	if 		(selection.options[selection.selectedIndex].value == "populationDensity")		value = populationDensity_by_countyId.get(countyId);
    else if (selection.options[selection.selectedIndex].value == "incomePerCapita")			value = incomePerCapita_by_countyId.get(countyId);
    else if (selection.options[selection.selectedIndex].value == "bachelor")				value = bachelor_by_countyId.get(countyId);
    else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")	value = populationBelowPoverty_by_countyId.get(countyId);
    else if (selection.options[selection.selectedIndex].value == "unemployment")			value = unemploymentRate_by_countyId.get(countyId);
    else if (selection.options[selection.selectedIndex].value == "election")				value = election_by_countyId.get(countyId);
    else if (selection.options[selection.selectedIndex].value == "foreignBorn")				value = foreignBorn_by_countyId.get(countyId);

    return value;
}

function updateOrderDescending(new_id, new_name, idArray, nameArray, valueArray, i)
{
	if (idArray.length > i)
	{
		var order = orderDescending(new_id, idArray[i], new_name, nameArray[i]);
		idArray[i] = order[0];
    	nameArray[i] = order[2];

    	var selection = document.getElementById("demographicSelectionBox");
    	if (selection.options[selection.selectedIndex].value == "populationDensity")
		{
			if (order[0] != 0) 	valueArray[i] = populationDensity_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
		{
			if (order[0] != 0) 	valueArray[i] = incomePerCapita_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		else if (selection.options[selection.selectedIndex].value == "bachelor")
		{
			if (order[0] != 0) 	valueArray[i] = bachelor_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
		{
			if (order[0] != 0) 	valueArray[i] = populationBelowPoverty_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		else if (selection.options[selection.selectedIndex].value == "unemployment")
		{
			if (order[0] != 0) 	valueArray[i] = unemploymentRate_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		else if (selection.options[selection.selectedIndex].value == "election")
		{
			if (order[0] != 0) 	valueArray[i] = election_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		else if (selection.options[selection.selectedIndex].value == "foreignBorn")
		{
			if (order[0] != 0) 	valueArray[i] = foreignBorn_by_countyId.get(order[0])
			else				valueArray[i] = 0;
		}
		
		updateOrderDescending(order[1], order[3], idArray, nameArray, valueArray, i+1);
	};
}

function orderDescending(id_a, id_b, name_a, name_b, map)
{
	var a = 0, b = 0;
	var selection = document.getElementById("demographicSelectionBox");
    	
    if (selection.options[selection.selectedIndex].value == "populationDensity")
	{
		if (id_a != 0)	a = populationDensity_by_countyId.get(id_a);
		if (id_b != 0)	b = populationDensity_by_countyId.get(id_b);
	}
	else if (selection.options[selection.selectedIndex].value == "incomePerCapita")
	{
		if (id_a != 0)	a = incomePerCapita_by_countyId.get(id_a);
		if (id_b != 0)	b = incomePerCapita_by_countyId.get(id_b);
	}
	else if (selection.options[selection.selectedIndex].value == "bachelor")
	{
		if (id_a != 0)	a = bachelor_by_countyId.get(id_a);
		if (id_b != 0)	b = bachelor_by_countyId.get(id_b);
	}
	else if (selection.options[selection.selectedIndex].value == "populationBelowPoverty")
	{
		if (id_a != 0)	a = populationBelowPoverty_by_countyId.get(id_a);
		if (id_b != 0)	b = populationBelowPoverty_by_countyId.get(id_b);
	}
	else if (selection.options[selection.selectedIndex].value == "unemployment")
	{
		if (id_a != 0)	a = unemploymentRate_by_countyId.get(id_a);
		if (id_b != 0)	b = unemploymentRate_by_countyId.get(id_b);
	}
	else if (selection.options[selection.selectedIndex].value == "election")
	{
		if (id_a != 0)	a = election_by_countyId.get(id_a);
		if (id_b != 0)	b = election_by_countyId.get(id_b);
	}
	else if (selection.options[selection.selectedIndex].value == "foreignBorn")
	{
		if (id_a != 0)	a = foreignBorn_by_countyId.get(id_a);
		if (id_b != 0)	b = foreignBorn_by_countyId.get(id_b);
	}

	if (a > b) return [id_a, id_b, name_a, name_b];
	else       return [id_b, id_a, name_b, name_a];
}

function trimTopFive(idArray, nameArray, valueArray)
{
	// Trim the array if less than five is found...
    var zeroElement = idArray.length;

  	for (var i = 0; i < idArray.length; i++)
  	{
  		if (idArray[i] == 0) zeroElement = i;
  	}

  	if (zeroElement < idArray.length)
  	{
  		var numRemoved = idArray.length - zeroElement;
  		idArray.splice(zeroElement, numRemoved);
  		nameArray.splice(zeroElement, numRemoved);
  		valueArray.splice(zeroElement, numRemoved);
  	};
}

</script>

</body>
</html>